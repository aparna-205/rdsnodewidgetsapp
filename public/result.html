<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://pixinvent.com/stack-responsive-bootstrap-4-admin-template/app-assets/css/bootstrap-extended.min.css">
<link rel="stylesheet" type="text/css" href="https://pixinvent.com/stack-responsive-bootstrap-4-admin-template/app-assets/fonts/simple-line-icons/style.min.css">
<link rel="stylesheet" type="text/css" href="https://pixinvent.com/stack-responsive-bootstrap-4-admin-template/app-assets/css/colors.min.css">
<link rel="stylesheet" type="text/css" href="https://pixinvent.com/stack-responsive-bootstrap-4-admin-template/app-assets/css/bootstrap.min.css">
<link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">

  <!-- Include ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    .grey-bg {  
        background-color: #ffffff;
    }
    .custom-section-card {
      max-width: 1000px; /* Adjust as needed */
      padding: 15px;
      font-size: 1.5em;
    }
    .card {
        max-width: 400px; 
        height :150px;
        padding: 15px;
        font-size: 1.5em;
        /* Adjust this value to your desired width */
    }
    /* Apply the custom styles to the second section cards */
.custom-second-section-card {
  max-width: 1000px;
  padding: 15px;
  font-size: 1.5em;
}

/* Make the table headers sticky at the top of the table */
table thead th {
  position: sticky;
  top: 0;
  background-color: #090c42;
  color: white;
}

/* Make the table headers z-index higher for stacking */
table thead th {
  z-index: 2;
}

/* Style the table */
table {
  width: 350px;
  border-collapse: collapse;
}

table, th, td {
  border: 1px solid #eeebeb;
}

th {
  padding: 5px;
  text-align: left;
}

td {
  padding: 5px;
  border: 1px solid #807c7c;
}

/* Limit the table container's width and add a horizontal scrollbar */
.table-container {
  max-width: 380px;
  overflow-x: auto;
}

/* Add vertical scrollbar for the table */
.table-scroll {
  max-height: 700px;
  overflow-y: auto;
}

    tr:nth-child(even){background-color: #ebeaec;}
    tr:hover {background-color: #ddd;}
    .label-width {
        width: 100px; /* Set the desired width */
        /* Add any other desired styles for the label */
        }
        .label-width1 {
          width: 100px; /* Adjust the width to your desired value */
        }

        .warning {
            color: #5dec24!important;
        }
        .success {
            color: #e909a6!important;
        }
        .notwarning {
            color: #fa0808!important;
        }
        .bold-uppercase {
            font-weight: bold;
            text-transform: uppercase;
        }
        
</style>
<div class="grey-bg container-fluid">
    <br>
    
  <section id="minimal-statistics">
    <h3 class="bold-uppercase">{{selectedTable}}</h3>

    <div class="row">
      <div class="col-2 mt-3 mb-1">
      </div>
    </div>
    <div class="row">
      <div class="col-xl-4 col-sm-6 col-12"> 
        <div class="card">
          <div class="card-content">
            <div class="card-body">
              <div class="media d-flex">
                <div class="align-self-center">
                    <i class="icon-graph success font-large-2 float-left"></i>
                </div>
                <div class="media-body text-right">
                  <h3 class="success">{{averageKmPerDay}}</h3>
                  <span>Average Km/Day</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-sm-6 col-12">
        <div class="card">
          <div class="card-content">
            <div class="card-body">
              <div class="media d-flex">
                <div class="align-self-center">
                    <i class="icon-power warning font-large-2 float-left custom-icon-color"></i>
                </div>
                <div class="media-body text-right">
                  <h3 class="warning">{{onToOffCount}}</h3>
                  <span>ignition On count</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-4 col-sm-6 col-12">
        <div class="card">
          <div class="card-content">
            <div class="card-body">
              <div class="media d-flex">
                <div class="align-self-center">
                    <i class="icon-power notwarning font-large-2 float-left custom-icon-color"></i>
                </div>
                <div class="media-body text-right">
                  <h3 class="danger">{{offToOnCount}}</h3>
                  <span>Ignition Off count</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </section>
    <section id="stats-subtitle">
      <div class="row">
        <div class="col-2 mt-3 mb-1">
        </div>
      </div>
    <div class="row">
      <div class="col-xl-6 col-md-6 ">
        <div class="custom-second-section-card">
          <div class="custom-second-section-card-content">
            <div class="custom-second-section-card-body cleartfix">
              <div class="media align-items-stretch">
                <div class="align-self-center">
                  <div id="speedGraph"><!-- Plotly chart will be drawn inside this DIV --></div>
                  <script>
                           // Parse the JSON data passed from the server
                    const avgSpeedDataMergedJSON = '{{avgSpeedDataMergedJSON}}';
                    const avgSpeedData = JSON.parse(avgSpeedDataMergedJSON);
    
                    // Extract the dates and speeds from the JSON data
                    const dates = Object.keys(avgSpeedData);
                    const avgSpeeds = Object.values(avgSpeedData);
    
                    const trace2 = {
                      x: dates,
                      y: avgSpeeds,
                      type: 'scatter',
                      mode: 'lines+markers', // Display lines and markers
                      name: 'Avg Speed',
                      line: {
                          color: 'rgb(153, 102, 255)', // Customize the color of the line
                          shape: 'spline', // Use 'spline' for a smooth line
                          smoothing: 1.3 // Adjust the smoothing value (1.3 is a reasonable starting point)
                      },
                      marker: {
                          color: 'rgb(75, 192, 192)', // Customize the color of the markers
                          size: 7, 
                          symbol: 'circle' 
                      }
                  };
                  
                  const layout = {
                    autosize: false,
                    width: 550,
                    height: 470,
                      title: 'Average Speed ',
                      xaxis: {
                          title: 'Date',
                          showgrid: false
                      },
                      yaxis: {
                          title: 'Speed',
                      }
                  };
                  Plotly.newPlot('speedGraph', [trace2], layout);
                </script>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-6 col-md-6">
        <div class="custom-second-section-card">
          <div class="custom-second-section-card-content">
            <div class="custom-second-section-card-body cleartfix">
              <div class="media align-items-stretch">
                <div class="align-self-center">
                  <div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
                  <script>

                    const maxSpeedDataJSON1 = '{{maxSpeedDataJSON1}}';
                    const maxSpeedData = JSON.parse(maxSpeedDataJSON1);
                    const date = Object.keys(maxSpeedData);
                    const maxSpeeds = Object.values(maxSpeedData);

                    var trace1 = {
                      x: date, 
                      y: maxSpeeds, 
                      type: 'bar',
                      name: 'Max Speed',
                      line:{
                        color: 'rgb(255, 99, 132)', // Customize the color of the line
                          shape: 'spline', // Use 'spline' for a smooth line
                          smoothing: 1.3
                      },
                      marker: {
                        color: 'rgb(54, 162, 235)', // Customize the color of the markers
                        size: 7, 
                        symbol: 'circle' 
                    }
                    };
                    var layout1 = {
                      autosize: false,
                      width: 550,
                      height: 470,
                      title: 'Max Speed',
                      xaxis: {
                          title: 'Date',
                          showgrid: false

                      },
                      yaxis: {
                          title: 'Speed'
                      }
                  };
                    Plotly.newPlot('myDiv',[trace1], layout1);
                </script>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xl-12 col-md-12" style="width: 18rem;">
        <div class="custom-section-card">
          <div class="custom-section-card-content">
            <div class="custom-section-card-body cleartfix">
              <div class="media align-items-stretch">
                <div class="align-self-center"></div>   
                <div id="heatmap"></div>
                 
                <label for="dateTimeRange" class="label-width1"></label>
                <input type="text" id="dateTimeRange" />
              
                <script>
    $(document).ready(function() {
      $('#dateTimeRange').daterangepicker({
        autoUpdateInput: true,
        timePicker: true,
        timePickerIncrement: 15,
        locale: {
          cancelLabel: 'Clear',
          format: 'MM/DD/YYYY HH:mm',
        },
        minDate: '09/01/2023', // Set the minimum date
        maxDate: moment(),    // Set the maximum date to the current date
        ranges: {
          'Last Week': [moment().startOf('week').subtract(1, 'week'), moment().startOf('week').subtract(1, 'second')],
          'This Week': [moment().startOf('week'), moment()],
          'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
          'Today': [moment(), moment()],
          'Last Month': [moment().startOf('month').subtract(1, 'month'), moment().startOf('month').subtract(1, 'second')],
          'This Month': [moment().startOf('month'), moment()]
        }
      });

      $('#dateTimeRange').on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY HH:mm') + ' - ' + picker.endDate.format('MM/DD/YYYY HH:mm'));
        const startDate = picker.startDate.toDate();
        const endDate = picker.endDate.toDate();
        renderHeatmap(startDate, endDate);
      });

      $('#dateTimeRange').on('cancel.daterangepicker', function() {
        $(this).val('');
        renderHeatmap(null, null);
      });

      const avgKmByDayAndHourJSON1 = '{{avgKmByDayAndHourJSON}}';
      const avgKmByDayAndHourJSON2 = JSON.parse(avgKmByDayAndHourJSON1);
      const dates3 = Object.keys(avgKmByDayAndHourJSON2);
      const z = dates3.map((date) => {
        return avgKmByDayAndHourJSON2[date].map(entry => entry.avgKm || 0);
      });

      const customColorScale = [
        ['0.0', 'rgb(189, 177, 180)'],
        ['0.111111111111', 'rgb(106, 215, 39)'],
        ['0.222222222222', 'rgb(7, 184, 48)'],
        ['0.333333333333', 'rgb(253,174,97)'],
        ['0.444444444444', 'rgb(254,224,144)'],
        ['0.555555555556', 'rgb(232, 122, 19)'],
        ['0.666666666667', 'rgb(214, 103, 114)'],
        ['0.777777777778', 'rgb(176, 23, 38)'],
        ['0.888888888889', 'rgb(176, 23, 38)'],
        ['1.0', 'rgb(179, 9, 26)']
      ];

      const data = [{
        x: Array.from({ length: 24 }, (_, i) => i), // Hours
        y: dates3, // Dates only
        z: z,
        type: 'heatmap',
        colorscale: customColorScale, // Use the custom color scale
        colorbar: {
          title: 'km',
          titleside: "right"
        }
      }];

      const layout3 = {
        width: 900,
        height: 400,
        xaxis: {
          title: 'Hour',
          tickmode: 'array',
          tickvals: Array.from({ length: 24 }, (_, i) => i),
          ticktext: Array.from({ length: 24 }, (_, i) => i.toString()),
        },
        yaxis: {
          tickvals: dates3,
          ticktext: dates3.map(function(date) {
            var dateObj = new Date(date);
            var weekday = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
            var dateString = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return dateString + "(" + weekday + ")";
          }),
          tickangle: -45,
          tickfont: {
            size: 8 // Adjust the font size for y-axis ticks
          }
        },
        title: 'utilization Heatmap',
        zaxis: {
          title: 'km'
        }
      };

      function renderHeatmap(startDate, endDate) {
        // Filter the data based on the selected date range
        const filteredDates = dates3.filter(date => {
          if (!startDate || !endDate) {
            return true; // No date range specified, so include all dates
          }
          const dateObj = new Date(date);
          return dateObj >= startDate && dateObj <= endDate;
        });
        const filteredZ = filteredDates.map(date => {
          return avgKmByDayAndHourJSON2[date].map(entry => entry.avgKm || 0);
        });

        // Update the heatmap data
        const newData = [{
          x: Array.from({ length: 24 }, (_, i) => i), // Hours
          y: filteredDates, // Filtered Dates
          z: filteredZ,
          type: 'heatmap',
          colorscale: customColorScale, // Use the custom color scale
          colorbar: {
            title: 'km',
            titleside: "right"
          }
        }];

        // Update the heatmap
        Plotly.react('heatmap', newData, layout3);
      }

      // Initial rendering of the heatmap with the default date range
      renderHeatmap(null, null);
    });
  </script>
                

                </div>    
              </div>
            </div>
          </div>
        </div>
      </div>

  </div>
</section>
